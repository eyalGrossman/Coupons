<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Coupons</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
<script type="text/javascript" src="jquery-1.11.2.js"></script>
<script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
<script src="config.js"></script>
<script src="couponsGUI.js"></script>

<script type="text/javascript">
"use strict"

function hasGeoLocationFunc(ob) {
    var location = {"latitude" : ob.coords.latitude, "longitude" : ob.coords.longitude};
    
    /*
     * AJAX request for the json with all of the coupons. Each key in the json data is a category that is mapped to all 
     * coupons of that same category.
     */
    $.ajax({
        dataType : "json",
        url : CONFIG.CONTROLLER_PATH.COUPONSJSON,
        data : location,
        success : showCouponsUser,
        error: function(xhr, textStatus, errorThrown) {
            console.log(xhr.responseText);
            console.log('request failed' + textStatus + "\n" + errorThrown);
            window.location = 'couponcontroller/error.jsp';
            window.location.href='couponcontroller/error.jsp';
            Window.open('couponcontroller/error', '_top');
         }
    });
}

function noGeoLocationFunc(ob) {
     alert(ob.message); //TODO: Go To error jsp.
     $.ajax({
         dataType : "json",
         url : CONFIG.CONTROLLER_PATH.COUPONSJSON,
         success : showCouponsUser
     });
}

if(window.navigator.geolocation) {
    console.log("has geo locations");
    window.navigator.geolocation.getCurrentPosition(hasGeoLocationFunc, noGeoLocationFunc);
}
else {
    console.log("geolocation is not supported"); //TODO: Go to error jsp ?
    $.ajax({
        dataType : "json",
        url : CONFIG.CONTROLLER_PATH.COUPONSJSON,
        success : showCouponsUser
    });
}

</script>
</head>

<body>
    <div data-role="page">
        <div data-role="header">
            <a href="/coupons/index.html" data-icon="back">Back</a>
            <h1>Coupons</h1>
        </div>

        <div data-role="content">
            <ul data-role="listview" data-theme="c" id="coupons_categories"></ul>
        </div>
        
        <div data-role="footer">
            <h5>Nahum Farchi and Eyal Grossman, 2015, Telhai &copy</h5>
        </div>
    </div>
</body>

</html>